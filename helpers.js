import{db}from"./db.js";export function validatePhone(e){const t=e.replace(/\D/g,"");return 10===t.length&&t.startsWith("0")}export function formatDate(e){return e?new Date(e).toLocaleDateString():""}export function calculateAge(e){if(!e)return"";const t=new Date(e),n=new Date;let a=n.getFullYear()-t.getFullYear();const o=n.getMonth()-t.getMonth();return(o<0||0===o&&n.getDate()<t.getDate())&&a--,a}export function debounce(e,t=300){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>e.apply(this,a),t)}}export function randomSerial(e=6){return Math.floor(Math.random()*Math.pow(10,e))}export function arrayToCSV(e){return e.map(e=>e.map(e=>"string"==typeof e&&e.includes(",")?`"${e.replace(/"/g,'""')}"`:e).join(",")).join("\r\n")}export function getFieldInputHtml(e,t=""){switch(e.type){case"text":default:return`<input type="text" class="form-control" id="f_${e.name}" value="${t||""}">`;case"number":case"integer":case"decimal":return`<input type="number" class="form-control" id="f_${e.name}" value="${t||""}" ${"integer"===e.type?'step="1"':""}>`;case"date":return`<input type="date" class="form-control" id="f_${e.name}" value="${t||""}">`;case"select_one":return`<select class="form-select" id="f_${e.name}">\n        ${(e.choices||"").split(",").map(e=>`<option value="${e.trim()}" ${t===e.trim()?" selected":""}>${e.trim()}</option>`).join("")}\n      </select>`}}export function validateFieldConstraint(e,t){if(!t||!e)return!0;const n=t.split(",");for(let t of n){const[n,a]=t.split("=");if("min"===n&&Number(e)<Number(a))return!1;if("max"===n&&Number(e)>Number(a))return!1;if("regex"===n&&!new RegExp(a).test(e))return!1}return!0}export function renderProfile(e,t){const{dashboardHash:n="#dashboard",getUser:a,updateUser:o,fieldLabels:r={}}=t,l=a();if(!l)return void(e.innerHTML='<div class="alert alert-danger">No user logged in.</div>');const s=r.username||"Username",i=r.fullName||"Full Name",d=r.contact||"Contact",c=r.currentPassword||"Current Password",m=r.newPassword||"New Password";e.innerHTML=`\n    <div class="container my-4">\n      <div class="card shadow mx-auto" style="max-width: 400px;">\n        <div class="card-body">\n          <h4 class="mb-3"><i class="bi bi-person-circle"></i> Update Profile</h4>\n          \n          <form id="profileForm" autocomplete="off">\n            <div class="mb-3">\n              <label class="form-label">${s}</label>\n              <input class="form-control" value="${l.username}" readonly>\n            </div>\n            \n            <div class="mb-3">\n              <label class="form-label">${i}</label>\n              <input class="form-control" id="fullName" value="${l.fullName||l.name||""}" \n                     placeholder="${i}" required>\n            </div>\n            \n            <div class="mb-3">\n              <label class="form-label">${d}</label>\n              <input class="form-control" id="contact" value="${l.contact||l.phone||""}" \n                     placeholder="${d}">\n            </div>\n            \n            <hr>\n            <h6>Change Password</h6>\n            \n            <div class="mb-2">\n              <label class="form-label">${c}</label>\n              <input type="password" class="form-control" id="currentPassword" autocomplete="current-password">\n            </div>\n            \n            <div class="mb-2">\n              <label class="form-label">${m}</label>\n              <input type="password" class="form-control" id="newPassword" autocomplete="new-password">\n            </div>\n            \n            <div class="d-flex justify-content-between mt-3">\n              <button class="btn btn-primary">Save Changes</button>\n              <a href="${n}" class="btn btn-secondary">Cancel</a>\n            </div>\n            \n            <div id="profileMsg" class="mt-2 small"></div>\n          </form>\n        </div>\n      </div>\n    </div>\n  `,document.getElementById("profileForm").onsubmit=function(e){e.preventDefault();const t=this.fullName.value.trim(),a=this.contact.value.trim(),r=this.currentPassword.value,s=this.newPassword.value;let i="";if("fullName"in l&&(l.fullName=t),"name"in l&&(l.name=t),"contact"in l&&(l.contact=a),"phone"in l&&(l.phone=a),r||s){if(!r||!s)return i="Both current and new password are required to change password.",this.querySelector("#profileMsg").textContent=i,void(this.querySelector("#profileMsg").className="text-danger mt-2 small");if(l.password!==r)return i="Current password is incorrect.",this.querySelector("#profileMsg").textContent=i,void(this.querySelector("#profileMsg").className="text-danger mt-2 small");l.password=s,l.lastPasswordChange=Date.now(),i="Password updated! "}o(l),this.querySelector("#profileMsg").textContent=i+"Profile updated!",this.querySelector("#profileMsg").className="text-success mt-2 small",setTimeout(()=>{window.location.hash=n},1200)}}export function isPasswordExpired(e){if(!e)return!1;const t=e.lastPasswordChange||0;return(Date.now()-t)/864e5>30}export function renderMobileTable(e,t,n){return`\n    <div class="table-responsive">\n      <table class="table table-bordered table-hover align-middle mobile-table">\n        <thead class="table-light">\n          <tr>\n            ${e.map(e=>`<th${e.mobile?"":' class="d-none d-md-table-cell"'}>${e.label}</th>`).join("")}\n            <th>Actions</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${t.map((t,a)=>`\n            <tr>\n              ${e.map(e=>`<td${e.mobile?` data-label='${e.label}'`:' class="d-none d-md-table-cell"'}>${t[e.key]||""}</td>`).join("")}\n              <td data-label="Actions">${n(t,a)}</td>\n            </tr>\n          `).join("")}\n        </tbody>\n      </table>\n    </div>\n    \n    <style>\n      @media (max-width: 768px) {\n        .mobile-table thead { display: none; }\n        .mobile-table tr {\n          display: block;\n          margin-bottom: 1rem;\n          border: 1px solid #dee2e6;\n          border-radius: 8px;\n        }\n        .mobile-table td {\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          padding: 0.5rem 1rem;\n          border: none;\n          border-bottom: 1px solid #eee;\n        }\n        .mobile-table td:last-child { border-bottom: none; }\n        .mobile-table td:before {\n          content: attr(data-label);\n          font-weight: bold;\n          flex: 0 0 40%;\n          color: #555;\n        }\n        .mobile-table td { flex-direction: row; }\n      }\n    </style>\n  `}export function showModal(e,t){const n=document.createElement("div");function a(){n.parentNode&&document.body.removeChild(n),document.removeEventListener("keydown",o),t&&t()}function o(e){"Escape"===e.key&&a()}return n.className="modal-overlay",n.innerHTML=`<div class='modal-content mx-auto'>${e}</div>`,document.body.appendChild(n),n.onclick=e=>{e.target===n&&a()},document.addEventListener("keydown",o),a}export function generatePatientID(e=new Date){const t=db.facility?.region?.replace(/[^A-Za-z]/g,"").slice(0,2).toUpperCase()||"RG",n=db.facility?.district?.replace(/[^A-Za-z]/g,"").slice(0,3).toUpperCase()||"DST",a=db.facility?.name?.replace(/[^A-Za-z]/g,"").slice(0,2).toUpperCase()||"FC";let o;do{o=String(Math.floor(1e5+9e5*Math.random()))}while(db.patients&&db.patients.some(e=>e.patientID?.includes(o)));const r=(t+n+a+o).split("");for(let e=r.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[r[e],r[t]]=[r[t],r[e]]}let l;if("string"==typeof e){const t=new Date(e);l=String(t.getFullYear()).slice(-2)}else l=String(new Date(e).getFullYear()).slice(-2);return`${r.join("")}${l}`}