import{db}from"./db.js";function toCSV(t,e,i={}){let n=[e.join(","),...t.map(t=>e.map(e=>`"${(t[e]??"").toString().replace(/"/g,'""')}"`).join(","))].join("\r\n");return i.footer&&(n+=`\r\n${i.footer}`),i.title&&(n=`${i.title}\r\n${n}`),n}function facilityMeta(){const t=db.facility||{};return[`Facility: ${t.name||""}`,`Region: ${t.region||""}`,`District: ${t.district||""}`,`Community: ${t.community||""}`,`Contact: ${t.contact||""}`,`Generated: ${(new Date).toLocaleString()}`].filter(Boolean).join(" | ")}function downloadFile(t,e,i="text/csv"){t.endsWith(".html")||t.endsWith(".htm")||(e=btoa(unescape(encodeURIComponent(e))),i="application/json");const n=new Blob([e],{type:i}),r=URL.createObjectURL(n),o=document.createElement("a");o.href=r,o.download=t,document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(r)},100)}export function exportPatientsJSON(){const t={meta:{type:"patients",facility:db.facility||{},generated:(new Date).toISOString()},patients:db.patients||[]};downloadFile("patients_export.json",encryptData(JSON.stringify(t)),"application/json")}export function exportVisitsJSON(){const t={meta:{type:"visits",facility:db.facility||{},generated:(new Date).toISOString()},visits:db.visits||[]};downloadFile("visits_export.json",encryptData(JSON.stringify(t)),"application/json")}export function exportServiceDeliveryJSON(){const t={meta:{type:"services",facility:db.facility||{},generated:(new Date).toISOString()},services:db.services||[]};downloadFile("services_export.json",encryptData(JSON.stringify(t)),"application/json")}export function exportRegistersJSON(){const t={meta:{type:"registers",facility:db.facility||{},generated:(new Date).toISOString()},registers:db.registers||[]};downloadFile("registers_export.json",encryptData(JSON.stringify(t)),"application/json")}export function exportSummaryReport(){const t=db.facility||{};downloadFile("summary_report.txt",[`SUMMARY REPORT - ${t.name||""}`,`Region: ${t.region||""} | District: ${t.district||""} | Community: ${t.community||""}`,`Contact: ${t.contact||""}`,"----------------------------------------",`Total Patients: ${(db.patients||[]).length}`,`Total Visits: ${(db.visits||[]).length}`,`Total Services: ${(db.services||[]).length}`,`Active Registers: ${(db.registers||[]).filter(t=>"active"===t.status).length}`,`Inactive Registers: ${(db.registers||[]).filter(t=>"inactive"===t.status).length}`,`Report Date: ${(new Date).toLocaleString()}`].join("\n"),"text/plain")}export function exportFullBackup(){const t={meta:{type:"full-backup",facility:db.facility||{},generated:(new Date).toISOString()},patients:db.patients||[],visits:db.visits||[],services:db.services||[],registers:db.registers||[],customPatientFields:db.customPatientFields||[]};downloadFile("full_backup.json",encryptData(JSON.stringify(t)),"application/json")}export async function importEncryptedData(t,e){if(!t)return alert("No file selected");const i=new FileReader;i.onload=function(t){let i=t.target.result,n=null;try{n=JSON.parse(decryptData(i))}catch(t){return void alert("Invalid or corrupted file.\n"+t)}if(!n||"object"!=typeof n)return void alert("Invalid file format");const r=(t,e,i)=>{const n=new Map((i||[]).map(t=>[t[e],t]));return(t||[]).forEach(t=>{t&&t[e]&&!n.has(t[e])&&n.set(t[e],t)}),Array.from(n.values())};n.patients&&(db.patients=r(n.patients,"patientID",db.patients)),n.visits&&(db.visits=r(n.visits,"visitID",db.visits)),n.services&&(db.services=r(n.services,"serviceID",db.services)),n.registers&&(db.registers=r(n.registers,"registerID",db.registers)),n.customPatientFields&&(db.customPatientFields=r(n.customPatientFields,"name",db.customPatientFields)),n.meta&&n.meta.facility&&(db.facility=Object.assign({},db.facility,n.meta.facility)),"function"==typeof e&&e(n),saveDb(),alert("Data imported and merged successfully.")},i.readAsText(t)}export function exportPatientA4(t){const e=db.facility||{},i=(db.patients||[]).find(e=>e.patientID===t);if(!i)return alert("Patient not found!");const n=(db.visits||[]).filter(e=>e.patientID===t),r=(db.services||[]).filter(e=>e.patientID===t),o=`${i.surname||""} ${i.otherNames||""}`.trim(),a=`\n    <html>\n    <head>\n      <title>Patient Report - ${o}</title>\n      <style>\n        body { font-family: Arial, sans-serif; margin: 40px; }\n        h2 { border-bottom: 1px solid #333; }\n        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }\n        th, td { border: 1px solid #999; padding: 6px 8px; }\n        th { background: #eee; }\n        .facility-header { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; }\n        .facility-meta { font-size: 0.95em; color: #555; margin-bottom: 20px; }\n        .footer { margin-top:40px;font-size:12px;color:#888; }\n        .logo { max-height: 60px; margin-bottom: 10px; }\n      </style>\n    </head>\n    <body>\n      ${e.image?`<img src="${e.image}" class="logo"><br>`:""}\n      <div class="facility-header">${e.name||""}</div>\n      <div class="facility-meta">\n        ${[e.region&&`Region: ${e.region}`,e.district&&`District: ${e.district}`,e.community&&`Community: ${e.community}`,e.contact&&`Contact: ${e.contact}`].filter(Boolean).join(" | ")}\n      </div>\n      <h2>Patient Report</h2>\n      <table>\n        <tr><th>ID</th><td>${i.patientID}</td></tr>\n        <tr><th>Name</th><td>${o}</td></tr>\n        <tr><th>Date of Birth</th><td>${i.dob||""}</td></tr>\n        <tr><th>Age</th><td>${i.age||""}</td></tr>\n        <tr><th>Sex</th><td>${i.sex||""}</td></tr>\n        <tr><th>Phone</th><td>${i.phone||""}</td></tr>\n        <tr><th>Address</th><td>${i.address||""}</td></tr>\n        <tr><th>ID Type</th><td>${i.idType||""}</td></tr>\n        <tr><th>ID Number</th><td>${i.idNumber||""}</td></tr>\n        <tr><th>Registration Date</th><td>${i.registrationDate||""}</td></tr>\n      </table>\n      <h3>Visits</h3>\n      <table>\n        <tr><th>Date</th><th>Service</th><th>Provider</th><th>Notes</th></tr>\n        ${n.map(t=>`<tr>\n          <td>${t.date||""}</td>\n          <td>${t.service||""}</td>\n          <td>${t.provider||""}</td>\n          <td>${t.notes||""}</td>\n        </tr>`).join("")}\n      </table>\n      <h3>Services Delivered</h3>\n      <table>\n        <tr><th>Date</th><th>Service</th><th>Provider</th><th>Outcome</th></tr>\n        ${r.map(t=>`<tr>\n          <td>${t.date||""}</td>\n          <td>${t.service||""}</td>\n          <td>${t.provider||""}</td>\n          <td>${t.outcome||""}</td>\n        </tr>`).join("")}\n      </table>\n      <footer class="footer">\n        ${facilityMeta()}<br>\n        Generated: ${(new Date).toLocaleString()}\n      </footer>\n    </body>\n    </html>\n  `,s=window.open("","_blank");s.document.write(a),s.document.close(),s.print()}export function encryptData(t){return btoa(unescape(encodeURIComponent(t)))}export function decryptData(t){try{return decodeURIComponent(escape(atob(t)))}catch{return t}}