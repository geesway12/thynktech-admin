import{db,saveDb}from"./db.js";import{showModal}from"./helpers.js";const fieldTypes=[{value:"text",label:"Text"},{value:"integer",label:"Integer"},{value:"decimal",label:"Decimal"},{value:"select_one",label:"Single Select (select_one)"},{value:"select_multiple",label:"Multiple Select (select_multiple)"},{value:"date",label:"Date"},{value:"time",label:"Time"},{value:"datetime",label:"DateTime"},{value:"note",label:"Note/Label"},{value:"calculate",label:"Calculation"},{value:"image",label:"Image"},{value:"audio",label:"Audio"},{value:"video",label:"Video"},{value:"file",label:"File Upload"},{value:"barcode",label:"Barcode"},{value:"qr_code",label:"QR Code"},{value:"geopoint",label:"Geopoint"},{value:"geotrace",label:"Geotrace"},{value:"geoshape",label:"Geoshape"}];db.registers||(db.registers=[]);export function renderRegisterMgmt(e){e.innerHTML=`\n    <div class="container my-4" style="padding: 20px;">\n      <div class="d-flex align-items-center justify-content-between mb-4">\n        <h4><i class="bi bi-journals"></i> Service Register Management</h4>\n        <div class="d-flex">\n          <button class="btn btn-success me-2" id="addRegBtn"><i class="bi bi-plus"></i> New Register</button>\n          <button class="btn btn-primary" id="uploadBtn"><i class="bi bi-cloud-upload"></i> Upload Registers</button>\n        </div>\n      </div>\n      <div id="formContainer" class="mb-4" style="display: none;"></div>\n      <div class="row" id="regList" style="gap: 10px;">\n        ${db.registers.map((e,t)=>`\n          <div class="col-md-3">\n            <div class="card shadow-sm" style="margin: 5px;">\n              <div class="card-body" style="padding: 10px;">\n                <h6>${e.name}</h6>\n                <small class="text-muted">${e.fields.length} fields</small>\n                <div class="mt-2">\n                  <button class="btn btn-sm btn-primary me-2" data-idx="${t}"><i class="bi bi-pencil"></i> Edit</button>\n                  <button class="btn btn-sm btn-danger" data-idx="${t}"><i class="bi bi-trash"></i></button>\n                  <button class="btn btn-sm btn-secondary assignBtn" data-idx="${t}"><i class="bi bi-person-plus"></i> Assign Users</button>\n                </div>\n                <div class="mt-2 small text-muted">\n                  Assigned: ${(e.assignedUsers||[]).map(e=>e).join(", ")||"None"}\n                </div>\n              </div>\n            </div>\n          </div>\n        `).join("")}\n      </div>\n      <a href="#admin-dashboard" class="btn btn-link mt-2" style="margin-top: 20px;"><i class="bi bi-arrow-left"></i> Back</a>\n    </div>\n  `,e.querySelectorAll("button.btn-primary").forEach(t=>t.onclick=()=>function(t={name:"",fields:[],assignedUsers:[]},n=null){const l=`\n      <div style="max-width:500px;">\n        <h5>${null!==n?"Edit Register":"New Register"}</h5>\n        <form id="regForm" autocomplete="off">\n          <div class="mb-2"><input class="form-control" id="regName" placeholder="Register Name (e.g. ANC, OPD)" required value="${t.name||""}"></div>\n          <div class="mb-3">\n            <div class="d-flex justify-content-between align-items-center">\n              <b>Fields</b>\n              <button type="button" class="btn btn-sm btn-success" id="addFieldBtn"><i class="bi bi-plus"></i> Add Field</button>\n            </div>\n            <ul class="list-group mt-2" id="fieldList">${(t.fields||[]).map((e,t)=>d(e,t)).join("")}</ul>\n          </div>\n          <div class="mb-2 d-flex justify-content-between">\n            <button class="btn btn-primary">${null!==n?"Save":"Create"}</button>\n            <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>\n          </div>\n        </form>\n      </div>\n    `,i=showModal(l);function s(){document.getElementById("fieldList").innerHTML=(t.fields||[]).map((e,t)=>d(e,t)).join(""),document.querySelectorAll(".editFieldBtn").forEach(e=>e.onclick=()=>a(t.fields[e.dataset.fidx],e.dataset.fidx)),document.querySelectorAll(".deleteFieldBtn").forEach(e=>e.onclick=()=>{confirm("Delete this field? Data already captured for this field will be kept in old records.")&&(t.fields.splice(e.dataset.fidx,1),s())}),document.querySelectorAll(".moveUpBtn").forEach(e=>e.onclick=()=>{const n=+e.dataset.fidx;n>0&&([t.fields[n-1],t.fields[n]]=[t.fields[n],t.fields[n-1]],s())}),document.querySelectorAll(".moveDownBtn").forEach(e=>e.onclick=()=>{const n=+e.dataset.fidx;n<t.fields.length-1&&([t.fields[n],t.fields[n+1]]=[t.fields[n+1],t.fields[n]],s())})}function a(e={name:"",type:"text",required:!1},n=null){const l=`\n        <div style="max-width:400px;">\n          <h6>${null!==n?"Edit Field":"Add Field"}</h6>\n          <form id="fieldForm">\n            <div class="mb-2"><input class="form-control" id="fieldName" placeholder="Field Name" required value="${e.name||""}"></div>\n            <div class="mb-2">\n              <select class="form-select" id="fieldType" required>\n                ${fieldTypes.map(t=>`<option value="${t.value}"${e.type===t.value?" selected":""}>${t.label}</option>`).join("")}\n              </select>\n            </div>\n            <div class="mb-2 form-check">\n              <input class="form-check-input" type="checkbox" id="fieldReq" ${e.required?"checked":""}>\n              <label class="form-check-label" for="fieldReq">Required</label>\n            </div>\n            <div class="mb-2"><input class="form-control" id="fieldDefault" placeholder="Default Value" value="${e.default||""}"></div>\n            <div class="mb-2"><input class="form-control" id="fieldConstraint" placeholder="Constraint/Validation (e.g. min=0,max=100)" value="${e.constraint||""}"></div>\n            <div class="mb-2" id="choicesRow" style="display:${["select_one","select_multiple"].includes(e.type)?"block":"none"}">\n              <input class="form-control" id="fieldChoices" placeholder="Choices (comma-separated, e.g. Yes,No,Unknown)" value="${e.choices||""}" ${["select_one","select_multiple"].includes(e.type)?"required":""}>\n            </div>\n            <div class="mb-2" id="calcRow" style="display:${"calculate"===e.type?"block":"none"}">\n              <input class="form-control" id="fieldCalc" placeholder="Calculation Formula (e.g. today() - dob)" value="${e.calc||""}">\n            </div>\n            <div class="mb-2 d-flex justify-content-between">\n              <button class="btn btn-primary">${null!==n?"Save":"Add"}</button>\n              <button type="button" class="btn btn-secondary" id="cancelFieldBtn">Cancel</button>\n            </div>\n          </form>\n        </div>\n      `,i=showModal(l);document.getElementById("cancelFieldBtn").onclick=()=>i(),document.getElementById("fieldType").onchange=function(){const e=["select_one","select_multiple"].includes(this.value);document.getElementById("choicesRow").style.display=e?"block":"none",document.getElementById("fieldChoices").required=e,document.getElementById("calcRow").style.display="calculate"===this.value?"block":"none"},document.getElementById("fieldForm").onsubmit=function(e){e.preventDefault();let l={name:this.fieldName.value,type:this.fieldType.value,required:this.fieldReq.checked,default:this.fieldDefault.value,constraint:this.fieldConstraint.value};["select_one","select_multiple"].includes(l.type)&&(l.choices=this.fieldChoices.value),"calculate"===l.type&&(l.calc=this.fieldCalc.value),null!==n?t.fields[n]=l:t.fields.push(l),i(),s()}}function d(e,t){return`<li class="list-group-item d-flex justify-content-between align-items-center" style="font-size:95%">\n        <div>\n          <b>${e.name}</b> <span class="badge bg-secondary">${e.type}</span>\n          ${e.required?'<span class="badge bg-danger ms-1">required</span>':""}\n          ${e.choices?'<span class="text-muted ms-1">['+e.choices+"]</span>":""}\n        </div>\n        <div>\n          <button type="button" class="btn btn-sm btn-light moveUpBtn" data-fidx="${t}"><i class="bi bi-chevron-up"></i></button>\n          <button type="button" class="btn btn-sm btn-light moveDownBtn" data-fidx="${t}"><i class="bi bi-chevron-down"></i></button>\n          <button type="button" class="btn btn-sm btn-accent editFieldBtn" data-fidx="${t}"><i class="bi bi-pencil"></i></button>\n          <button type="button" class="btn btn-sm btn-danger deleteFieldBtn" data-fidx="${t}"><i class="bi bi-trash"></i></button>\n        </div>\n      </li>`}document.getElementById("cancelBtn").onclick=()=>i(),document.getElementById("addFieldBtn").onclick=()=>a(),s(),document.getElementById("regForm").onsubmit=function(l){l.preventDefault(),t.name=this.regName.value,t.assignedUsers||(t.assignedUsers=[]),null!==n?db.registers[n]=t:db.registers.push(t),saveDb(),i(),renderRegisterMgmt(e)}}(db.registers[t.dataset.idx],t.dataset.idx)),e.querySelectorAll("button.btn-danger").forEach(t=>t.onclick=()=>{confirm("Delete this register? All service data will be kept but new entry will be disabled for this register.")&&(db.registers.splice(t.dataset.idx,1),saveDb(),renderRegisterMgmt(e))}),e.querySelector("#addRegBtn").onclick=()=>{const t=e.querySelector("#formContainer");t.style.display="block";let n=[];function l(){const e=t.querySelector("#fieldList");e.innerHTML=n.map((e,t)=>`\n        <li class="list-group-item d-flex justify-content-between align-items-center" style="font-size:95%">\n          <div>\n            <b>${e.name}</b> <span class="badge bg-secondary">${e.type}</span>\n            ${e.required?'<span class="badge bg-danger ms-1">required</span>':""}\n            ${e.choices?'<span class="text-muted ms-1">['+e.choices+"]</span>":""}\n          </div>\n          <div>\n            <button type="button" class="btn btn-sm btn-light moveUpBtn" data-fidx="${t}"><i class="bi bi-chevron-up"></i></button>\n            <button type="button" class="btn btn-sm btn-light moveDownBtn" data-fidx="${t}"><i class="bi bi-chevron-down"></i></button>\n            <button type="button" class="btn btn-sm btn-accent editFieldBtn" data-fidx="${t}"><i class="bi bi-pencil"></i></button>\n            <button type="button" class="btn btn-sm btn-danger deleteFieldBtn" data-fidx="${t}"><i class="bi bi-trash"></i></button>\n          </div>\n        </li>\n      `).join(""),e.querySelectorAll(".editFieldBtn").forEach(e=>e.onclick=()=>showFieldForm(n[e.dataset.fidx],e.dataset.fidx)),e.querySelectorAll(".deleteFieldBtn").forEach(e=>e.onclick=()=>{confirm("Delete this field?")&&(n.splice(e.dataset.fidx,1),l())}),e.querySelectorAll(".moveUpBtn").forEach(e=>e.onclick=()=>{const t=+e.dataset.fidx;t>0&&([n[t-1],n[t]]=[n[t],n[t-1]],l())}),e.querySelectorAll(".moveDownBtn").forEach(e=>e.onclick=()=>{const t=+e.dataset.fidx;t<n.length-1&&([n[t],n[t+1]]=[n[t+1],n[t]],l())})}t.innerHTML='\n      <div class="card shadow-sm">\n        <div class="card-body">\n          <h5>Create New Register</h5>\n          <form id="regForm" autocomplete="off">\n            <div class="mb-2">\n              <input class="form-control" id="regName" placeholder="Register Name (e.g. ANC, OPD)" required>\n            </div>\n            <div class="mb-3">\n              <div class="d-flex justify-content-between align-items-center">\n                <b>Fields</b>\n                <button type="button" class="btn btn-sm btn-success" id="addFieldBtn"><i class="bi bi-plus"></i> Add Field</button>\n              </div>\n              <ul class="list-group mt-2" id="fieldList"></ul>\n            </div>\n            <div class="mb-2 d-flex justify-content-between">\n              <button class="btn btn-primary">Create</button>\n              <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>\n            </div>\n          </form>\n        </div>\n      </div>\n    ',t.querySelector("#addFieldBtn").onclick=()=>function(e={name:"",type:"text",required:!1},i=null){const s=t.querySelector("#regForm");let a=t.querySelector("#inlineFieldFormRow");a&&a.remove();const d=document.createElement("div");d.id="inlineFieldFormRow",d.innerHTML=`\n        <div class="card card-body mb-2">\n          <form id="fieldForm">\n            <div class="row g-2 align-items-center">\n              <div class="col-md-4"><input class="form-control" id="fieldName" placeholder="Field Name" required value="${e.name||""}"></div>\n              <div class="col-md-3">\n                <select class="form-select" id="fieldType" required>\n                  ${fieldTypes.map(t=>`<option value="${t.value}"${e.type===t.value?" selected":""}>${t.label}</option>`).join("")}\n                </select>\n              </div>\n              <div class="col-md-2 form-check">\n                <input class="form-check-input" type="checkbox" id="fieldReq" ${e.required?"checked":""}>\n                <label class="form-check-label" for="fieldReq">Required</label>\n              </div>\n              <div class="col-md-3"><input class="form-control" id="fieldDefault" placeholder="Default Value" value="${e.default||""}"></div>\n            </div>\n            <div class="row g-2 mt-2">\n              <div class="col-md-6"><input class="form-control" id="fieldConstraint" placeholder="Constraint/Validation (e.g. min=0,max=100)" value="${e.constraint||""}"></div>\n              <div class="col-md-6" id="choicesRow" style="display:${["select_one","select_multiple"].includes(e.type)?"block":"none"}">\n                <input class="form-control" id="fieldChoices" placeholder="Choices (comma-separated, e.g. Yes,No,Unknown)" value="${e.choices||""}" ${["select_one","select_multiple"].includes(e.type)?"required":""}>\n              </div>\n              <div class="col-md-6" id="calcRow" style="display:${"calculate"===e.type?"block":"none"}">\n                <input class="form-control" id="fieldCalc" placeholder="Calculation Formula (e.g. today() - dob)" value="${e.calc||""}">\n              </div>\n            </div>\n            <div class="mt-2 d-flex justify-content-end gap-2">\n              <button class="btn btn-primary">${null!==i?"Save Field":"Add Field"}</button>\n              <button type="button" class="btn btn-secondary" id="cancelFieldBtn">Cancel</button>\n            </div>\n          </form>\n        </div>\n      `,s.insertBefore(d,s.querySelector(".mb-3"));d.querySelector("#fieldType").onchange=function(){const e=["select_one","select_multiple"].includes(this.value);d.querySelector("#choicesRow").style.display=e?"block":"none",d.querySelector("#fieldChoices").required=e,d.querySelector("#calcRow").style.display="calculate"===this.value?"block":"none"},d.querySelector("#cancelFieldBtn").onclick=()=>d.remove(),d.querySelector("#fieldForm").onsubmit=function(e){e.preventDefault();let t={name:this.fieldName.value,type:this.fieldType.value,required:this.fieldReq.checked,default:this.fieldDefault.value,constraint:this.fieldConstraint.value};["select_one","select_multiple"].includes(t.type)&&(t.choices=this.fieldChoices.value),"calculate"===t.type&&(t.calc=this.fieldCalc.value),null!==i?n[i]=t:n.push(t),d.remove(),l()}}(),l(),t.querySelector("#cancelBtn").onclick=()=>{t.style.display="none",t.innerHTML=""},t.querySelector("#regForm").onsubmit=function(l){l.preventDefault();const i={name:this.regName.value,id:`REG${Date.now().toString().slice(-6)}`,fields:n,assignedUsers:[]};db.registers.push(i),saveDb(),t.style.display="none",t.innerHTML="",renderRegisterMgmt(e)}},e.querySelectorAll(".assignBtn").forEach(t=>t.onclick=()=>function(t,n){const l=db.users||[],i=`\n      <div class="assign-users-modal">\n        <h5>Assign Users to ${t.name}</h5>\n        <form id="assignForm">\n          <div class="mb-3">\n            ${0===l.length?'<div class="alert alert-warning">No users found.</div>':""}\n            <div class="form-check-container">\n              ${l.map((e,n)=>`\n                <div class="form-check mb-2">\n                  <input class="form-check-input" type="checkbox" id="user_${n}" value="${e.username}" ${t.assignedUsers&&t.assignedUsers.includes(e.username)?"checked":""}>\n                  <label class="form-check-label" for="user_${n}">${e.username} (${e.role})</label>\n                </div>\n              `).join("")}\n            </div>\n          </div>\n          <div class="mb-2 d-flex gap-2 justify-content-between">\n            <button class="btn btn-primary">Save</button>\n            <button type="button" class="btn btn-secondary" id="cancelAssignBtn">Cancel</button>\n          </div>\n        </form>\n      </div>\n    `,s=showModal(i);document.getElementById("cancelAssignBtn").onclick=()=>s(),document.getElementById("assignForm").onsubmit=function(l){l.preventDefault(),t.assignedUsers=Array.from(this.querySelectorAll("input[type=checkbox]:checked")).map(e=>e.value),db.registers[n]=t,saveDb(),s(),renderRegisterMgmt(e)}}(db.registers[t.dataset.idx],t.dataset.idx)),e.querySelector("#uploadBtn").onclick=()=>{const t=e.querySelector("#formContainer");t.style.display="block",t.innerHTML='\n      <div class="card shadow-sm">\n        <div class="card-body">\n          <h5>Upload Registers</h5>\n          <form id="uploadForm">\n            <label for="registerUploadInput" class="form-label">Upload Registers (.xlsx format):</label>\n            <input type="file" id="registerUploadInput" class="form-control" accept=".xlsx">\n            <div class="mt-3 d-flex justify-content-between">\n              <button class="btn btn-primary">Upload</button>\n              <button type="button" class="btn btn-secondary" id="cancelUploadBtn">Cancel</button>\n            </div>\n          </form>\n        </div>\n      </div>\n    ',e.querySelector("#cancelUploadBtn").onclick=()=>{t.style.display="none",t.innerHTML=""},e.querySelector("#uploadForm").onsubmit=function(n){n.preventDefault();const l=this.registerUploadInput.files[0];l?function(e,t){const n=new FileReader;n.onload=function(e){const n=new Uint8Array(e.target.result),l=XLSX.read(n,{type:"array"}),i=l.SheetNames[0],s=l.Sheets[i],a=XLSX.utils.sheet_to_json(s,{header:1}),d={};a.forEach((e,t)=>{if(0===t)return;const[n,l,i,s,a,c,o,r]=e;n&&l&&i&&(d[n]||(d[n]={name:n,fields:[]}),d[n].fields.push({name:l,type:i,required:"1"===s,choices:a,default:c,constraint:o,calc:r}))}),t(Object.values(d))},n.readAsArrayBuffer(e)}(l,function(n){db.registers.push(...n),saveDb(),t.style.display="none",t.innerHTML="",renderRegisterMgmt(e),alert("Registers uploaded successfully!")}):alert("Please select a file to upload.")}}}